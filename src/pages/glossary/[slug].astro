---
import MainLayout from '~layouts/MainLayout.astro';
import { getCollection } from 'astro:content';
import '~styles/partials/markdown.scss';
import type { CollectionEntry } from 'astro:content';
import ArrowLeft from 'phosphor-astro/ArrowLeft.astro';
import Typography from '~components/ui/Typography.astro';
import { PAGES } from '~consts/pages';
import { Image } from 'astro:assets';
import glass from '~assets/doodles/glass.svg';

export async function getStaticPaths() {
  const glossaryTerms = (await getCollection(
    'glossary',
  )) as CollectionEntry<'glossary'>[];
  return glossaryTerms.map((term) => ({
    params: { slug: term.slug },
    props: { term },
  }));
}

type Props = {
  term: CollectionEntry<'glossary'>;
};

const { term } = Astro.props;
const { Content } = await term.render();

// Get all terms for related terms links
const allTerms = await getCollection('glossary');

// Get related terms data
const relatedTermsData = term.data.relatedTerms
  .map((slug) => allTerms.find((t) => t.slug === slug))
  .filter(Boolean) as CollectionEntry<'glossary'>[];

// Get related blog posts
const allBlogPosts = await getCollection('blog');
const relatedPostsData = term.data.relatedPosts
  .map((slug) => allBlogPosts.find((p) => p.slug === slug))
  .filter(Boolean) as CollectionEntry<'blog'>[];

// SEO - automatically add suffix
const baseTitle = term.data.seo?.title || term.data.term;
const pageTitle = `${baseTitle} | Software Estimation Glossary`;
const pageDescription =
  term.data.seo?.description ||
  term.data.definition ||
  `Learn about ${term.data.term} in software project estimation.`;
---

<MainLayout title={pageTitle} description={pageDescription}>
  <article class="markdown" aria-labelledby="term-title">
    <div class="postHeader">
      <a href={PAGES.GLOSSARY} class="backButton">
        <ArrowLeft width={'2.6rem'} height={'2.6rem'} />
        <Typography class="backButtonText" tag="span" styling="bodyL">
          Back to Glossary
        </Typography>
      </a>

      <div class="termHeader">
        <div class="doodle">
          <Image src={glass} alt="magnifying glass" />
        </div>

        <h1 id="term-title">{term.data.term}</h1>
        <p class="description">{term.data.definition}</p>
      </div>
    </div>

    <div class="post-content">
      <Content />
    </div>

    {
      relatedTermsData.length > 0 && (
        <div class="relatedSection">
          <Typography tag="h2" styling="headingS">
            Related Terms
          </Typography>

          <div class="relatedLinks">
            {relatedTermsData.map((relatedTerm) => (
              <a href={`${PAGES.GLOSSARY}/${relatedTerm.slug}`}>
                <Typography tag="span" styling="bodyL">
                  {relatedTerm.data.term}
                </Typography>
              </a>
            ))}
          </div>
        </div>
      )
    }

    {
      relatedPostsData.length > 0 && (
        <div class="relatedSection">
          <Typography tag="h2" styling="headingS">
            Related Articles
          </Typography>

          <div class="relatedLinks">
            {relatedPostsData.map((post) => (
              <a href={`${PAGES.BLOG}/${post.slug}`}>
                <Typography tag="span" styling="bodyL">
                  {post.data.title}
                </Typography>
              </a>
            ))}
          </div>
        </div>
      )
    }

    <div class="postFooter">
      <a href={PAGES.GLOSSARY} class="backButton">
        <ArrowLeft width={'2.6rem'} height={'2.6rem'} />
        <Typography class="backButtonText" tag="span" styling="bodyL">
          Back to Glossary
        </Typography>
      </a>
    </div>
  </article>
</MainLayout>

<style lang="scss">
  @use '~styles/mixins/media' as *;

  article {
    max-width: 800px;
    margin: 0 auto;
    margin-top: 100px;
    padding: var(--s-16);
  }

  .termHeader {
    position: relative;
    padding: var(--s-32) var(--s-100) var(--s-32) var(--s-16);
    margin-top: var(--s-32);
    border-radius: var(--radius-12);
    background: var(--gray-100);

    h1 {
      margin-top: 0;
    }

    p {
      margin-bottom: 0;
    }
  }

  .doodle {
    position: absolute;
    display: block;
    width: 10rem;
    height: 10rem;
    right: 1rem;
    top: -4rem;

    @include media-min('sm') {
      width: 15rem;
      height: 15rem;
      right: 1rem;
      top: -6rem;
    }
  }

  .postHeader {
    margin-bottom: var(--s-32);
  }

  .postFooter {
    margin-top: var(--s-32);
  }

  .backButton {
    display: flex;
    gap: var(--s-12);
    align-items: center;

    width: fit-content;
    padding: var(--s-12) 0;
    border-radius: var(--radius-8);

    color: var(--text);
    text-decoration: none;

    :global(.backButtonText) {
      padding-top: var(--s-2);
    }
  }

  .relatedSection {
    margin-top: var(--s-40);
    padding-top: var(--s-24);
    border-top: 1px solid var(--gray-200);
  }

  .relatedLinks {
    display: flex;
    flex-direction: column;
    gap: var(--s-8);
    margin-top: var(--s-16);

    a {
      color: var(--text);
      text-decoration: underline;

      &:hover {
        color: var(--gray-1200);
      }
    }
  }
</style>
